# app.py
import streamlit as st
import plotly.graph_objects as go
from logic import get_stock_data, calculate_river

# è¨­å®šé é¢æ¨™é¡Œèˆ‡å¯¬åº¦
st.set_page_config(page_title="å°è‚¡è‡ªå‹•åŒ–ä¼°å€¼ç³»çµ±", layout="wide")

st.title("ğŸ“ˆ å°è‚¡åƒ¹å€¼æ²³æµåœ–åˆ†æ")
st.markdown("æœ¬ç³»çµ±æ¡ç”¨ **å‹•æ…‹æœ¬ç›Šæ¯”æ¨™æº–å·®é€šé“** ä¾†åˆ¤æ–·è‚¡åƒ¹ä½éšã€‚")

# å´é‚Šæ¬„
sidebar = st.sidebar
sidebar.header("åƒæ•¸è¨­å®š")
stock_id = sidebar.text_input("è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ", "2330")
st.sidebar.markdown("---")
st.sidebar.info("è³‡æ–™ä¾†æº: FinMind Open Data")

if st.button("é–‹å§‹åˆ†æ") or stock_id:
    with st.spinner(f"æ­£åœ¨åˆ†æ {stock_id} çš„æ•¸æ“š..."):
        # ç²å–æ•¸æ“š (ç´” API æ¨¡å¼)
        df = get_stock_data(stock_id)
        
        if df is None or len(df) < 250:
            st.error(f"ç„¡æ³•ç²å– {stock_id} è¶³å¤ çš„æ•¸æ“šï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢ºæˆ–è©²è‚¡ä¸Šå¸‚æ™‚é–“å¤ªçŸ­ã€‚")
        else:
            # é‹ç®—
            df = calculate_river(df)
            latest = df.iloc[-1]
            
            # --- 1. é—œéµæ•¸æ“šæŒ‡æ¨™ ---
            col1, col2, col3, col4 = st.columns(4)
            col1.metric("ç›®å‰è‚¡åƒ¹", f"{latest['close_price']:.2f}")
            col2.metric("æœ¬ç›Šæ¯” (PE)", f"{latest['PER']:.2f}")
            col3.metric("è‚¡åƒ¹æ·¨å€¼æ¯” (PB)", f"{latest['PBR']:.2f}")
            
            # åˆ¤æ–·ä½éš
            status = "åˆç†"
            if latest['close_price'] < latest['river_low_1sd']: status = "ä½ä¼° (ä¾¿å®œ)"
            if latest['close_price'] > latest['river_high_1sd']: status = "é«˜ä¼° (æ˜‚è²´)"
            col4.metric("ç•¶å‰ä½éšè©•åƒ¹", status)

            # --- 2. ç¹ªè£½äº’å‹•å¼åœ–è¡¨ ---
            fig = go.Figure()

            # ç¹ªè£½å€é–“ (ç”±ä¸Šè€Œä¸‹)
            x_axis = df['date']
            
            # ç´…è‰²é«˜ä¼°å€
            fig.add_trace(go.Scatter(x=x_axis, y=df['river_high_2sd'], mode='lines', line=dict(width=0), name='+2SD'))
            fig.add_trace(go.Scatter(x=x_axis, y=df['river_high_1sd'], mode='lines', line=dict(width=0), fill='tonexty', fillcolor='rgba(255, 0, 0, 0.2)', name='æ˜‚è²´å€'))
            
            # é»ƒè‰²åˆç†å€ (ä¸ŠåŠéƒ¨)
            fig.add_trace(go.Scatter(x=x_axis, y=df['river_mean'], mode='lines', line=dict(color='gray', dash='dash', width=1), fill='tonexty', fillcolor='rgba(255, 165, 0, 0.1)', name='å¹³å‡å€¼'))
            
            # ç¶ è‰²ä½ä¼°å€ (ä¸‹åŠéƒ¨)
            fig.add_trace(go.Scatter(x=x_axis, y=df['river_low_1sd'], mode='lines', line=dict(width=0), fill='tonexty', fillcolor='rgba(0, 255, 0, 0.1)', name='åˆç†åä½'))
            fig.add_trace(go.Scatter(x=x_axis, y=df['river_low_2sd'], mode='lines', line=dict(width=0), fill='tonexty', fillcolor='rgba(0, 255, 0, 0.3)', name='ä¾¿å®œå€'))

            # æ”¶ç›¤åƒ¹
            fig.add_trace(go.Scatter(x=x_axis, y=df['close_price'], mode='lines', line=dict(color='black', width=2), name='æ”¶ç›¤åƒ¹'))

            fig.update_layout(title=f"{stock_id} æœ¬ç›Šæ¯”æ²³æµåœ– (è¿‘5å¹´)", hovermode="x unified", height=600)
            st.plotly_chart(fig, use_container_width=True)

            # --- 3. é¡¯ç¤ºæ•¸æ“šè¡¨æ ¼ ---
            with st.expander("æŸ¥çœ‹è©³ç´°æ­·å²æ•¸æ“š"):
                st.dataframe(df.sort_values('date', ascending=False).head(100))